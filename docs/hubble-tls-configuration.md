# Hubble TLS Configuration Guide

This document explains how to configure Hubble relay and UI with and without TLS in this Kubernetes cluster.

## Overview

Hubble relay component requires TLS certificates to function properly. In our cluster, we have implemented a hybrid approach that allows us to:

1. Run Hubble relay with TLS completely enabled (for production)
2. Run Hubble relay with TLS disabled but with certificate paths available (for development or when proper CA is not yet available)

## Understanding Hubble TLS Requirements

According to the [Cilium documentation](https://docs.cilium.io/en/stable/observability/hubble/configuration/tls/#hubble-enable-tls), when using Hubble:

- The proper way to configure Hubble without TLS is to:
  1. Use the `--disable-client-tls` and `--disable-server-tls` flags in command-line arguments
  2. Set the corresponding `disable-client-tls: true` and `disable-server-tls: true` in the configuration
  3. Do not specify certificate paths when TLS is disabled

## Configuration Options

### No-TLS Mode with Certificate Paths (Development)

This mode creates self-signed certificates but doesn't enforce TLS validation, making it suitable for development environments or when a proper CA is not yet available.

```bash
# Generate certificates and deploy Hubble with TLS disabled but certificate paths available
./scripts/configure-hubble-tls.sh --no-tls
```

### Full TLS Mode (Production)

This mode enforces proper TLS validation and is recommended for production environments.

```bash
# Deploy Hubble with TLS fully enabled
./scripts/configure-hubble-tls.sh --tls
```

## Implementation Details

### Certificate Generation

Self-signed certificates are automatically generated by the `generate-hubble-certs.sh` script and stored as Kubernetes secrets:

- `hubble-relay-client-certs` - Client certificates for Hubble relay
- `hubble-relay-server-certs` - Server certificates for Hubble relay

### Configuration Files

The repository contains separate configuration files for both modes:

- **TLS Disabled (with certificate paths)**:
  - `networking/cilium/no-tls/hubble-relay-config-no-tls-with-certs.yaml`
  - `networking/cilium/no-tls/hubble-relay-deployment-no-tls-with-certs.yaml`

- **TLS Enabled**:
  - `networking/cilium/hubble-relay-config.yaml`
  - Standard deployment files from the networking kustomization

## Troubleshooting

If you encounter TLS-related errors in Hubble relay, run the fix-hubble script:

```bash
./scripts/fix-hubble.sh
```

This script will:
1. Generate certificates if they don't exist
2. Apply the correct configuration based on your current TLS mode
3. Restart the Hubble components
4. Verify that everything is working properly

## Important Notes

- In both modes, certificates are created to satisfy Hubble relay's path requirements
- The difference is in the `tls-disabled` flag that determines whether TLS validation is enforced
- This approach ensures that certificates exist when needed while allowing flexibility in TLS enforcement

## CI/CD Integration

The CI/CD pipeline should apply the appropriate configuration based on the target environment:

- For production environments: Use the TLS enabled mode
- For development or testing: Use the no-TLS mode with certificate paths

Always ensure that any changes to the Hubble configuration are properly reflected in the CI/CD pipeline configuration.
